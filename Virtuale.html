<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Incasso Virtuale AWP — 58mm</title>
<style>
  /* ===== Tema crema/grigio pulito ===== */
  :root{
    --bg:#f6f4ef;
    --panel:#ffffff;
    --ink:#222222;
    --muted:#666666;
    --line:#dcd8d0;
    --line-strong:#bdb7ad;

    --good:#106e2a;
    --bad:#a32228;

    --pill-pos-bg:#e7f6ec;
    --pill-pos-bd:#a6dbb5;
    --pill-neg-bg:#fdebec;
    --pill-neg-bd:#f0a1a5;

    --focus:#2b6cb0;
    --accent:#2f4f84;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    line-height:1.25;
  }

  /* ===== Barra superiore sempre visibile ===== */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg,#fbfaf7,#f1eee8);
    border-bottom:1px solid var(--line);
    padding:10px 12px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand h1{margin:0; font-size:18px}
  .sub{color:var(--muted); font-size:12px; margin-top:4px}
  .status{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .pill{
    font-weight:800; font-size:13px; border-radius:999px; padding:6px 10px;
    border:1px solid var(--line);
  }
  .pill.pos{background:var(--pill-pos-bg); border-color:var(--pill-pos-bd); color:var(--good)}
  .pill.neg{background:var(--pill-neg-bg); border-color:var(--pill-neg-bd); color:var(--bad)}
  .pill.neu{background:#eeeeee; color:#333}

  .btn{
    border:1px solid var(--line); background:#fff; border-radius:10px;
    padding:10px 12px; font-weight:700; cursor:pointer; color:#263a64;
  }
  .btn:hover{filter:brightness(0.98)}
  .btn:focus{outline:3px solid #cfe2ff; border-color:#aac8ff}
  .btn.primary{background:#eef3fb; border-color:#c7d6f4; color:#274b87}
  .btn.ghost{background:#ffffff}

  /* ===== Layout ===== */
  .wrap{padding:12px; max-width:1100px; margin:0 auto}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:980px){ .grid{grid-template-columns:1.1fr .9fr} }
  .card{
    background:linear-gradient(180deg,var(--panel),#fdfcf9);
    border:1px solid var(--line);
    border-radius:14px; padding:14px;
  }
  .card h2{margin:0 0 8px; font-size:16px}
  .muted{color:var(--muted)}
  .sep{height:1px; background:var(--line); margin:10px 0}

  .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .row4{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  @media (max-width:900px){ .row2,.row3,.row4{grid-template-columns:1fr} }

  label{font-size:13px; color:#444; margin-bottom:6px; display:block}
  input[type=number],input[type=text],input[type=date]{
    width:100%; padding:12px; border-radius:10px; border:1px solid #cec9bf; background:#fff; font-size:16px; color:#222;
  }
  input:focus{outline:3px solid #d7e8ff; border-color:#b7cff1}

  table{width:100%; border-collapse:separate; border-spacing:0; font-size:15px}
  th,td{padding:10px 6px; text-align:right; border-bottom:1px dashed var(--line)}
  td:first-child, th:first-child{text-align:left}
  th{
    background:#f6f4f0; font-weight:700; color:#3a3a3a;
    border-top:1px solid var(--line); border-bottom:1px solid var(--line);
  }

  .stat-badges{display:flex; gap:8px; flex-wrap:wrap;}
  .badge{
    background:#fff; border:1px solid var(--line); border-radius:999px;
    padding:6px 10px; font-size:12px; color:#394867;
  }

  /* ===== Ticket preview & print ===== */
  .ticket-preview-wrap{display:none; margin-top:10px}
  .ticket-preview{
    width:58mm; max-width:100%; background:#fff; color:#000;
    border:1px dashed var(--line-strong); border-radius:6px;
    padding:6mm 4mm;
    box-shadow:0 2px 10px #0000001a;
  }
  .t-head{
    border:2px solid var(--line-strong); border-radius:6px; padding:6px; text-align:center;
    margin-bottom:6px;
  }
  .t-head .title{font-weight:800; font-size:14px}
  .t-head .sub{font-size:11px; color:#333}
  .t-sec{margin:6px 0}
  .t-sec h4{margin:0 0 4px; font-size:12px; border-bottom:1px solid #bbb; padding-bottom:2px}
  .t-row{display:flex; justify-content:space-between; font-size:12px; padding:2px 0}
  .t-row b{font-weight:700}
  .t-foot{border-top:2px dashed #999; margin-top:6px; padding-top:6px; font-size:12px}
  .t-emph{
    border:2px solid #000; border-radius:4px; padding:4px; text-align:center; font-weight:800; margin-top:4px;
  }
  .t-note{font-size:11px; margin-top:6px}

  @page{ size:58mm auto; margin:2mm }
  @media print{
    body{background:#fff}
    .topbar, .wrap{display:none !important}
    .ticket-print{display:block !important}
  }
  .ticket-print{display:none}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <h1>Incasso Virtuale AWP</h1>
      <div id="subInfo" class="sub">Locale: — • Data: —</div>
    </div>
    <div class="status">
      <span id="diffPill" class="pill neu">—</span>
      <button id="btnPreview" class="btn ghost">Anteprima Ticket</button>
      <button id="btnPrint" class="btn primary">Stampa Ticket 58 mm</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- DATI -->
      <section class="card">
        <h2>Dati</h2>
        <div class="row4">
          <div><label>Nome locale</label><input id="nomeLocale" type="text" placeholder="Es. Bar Gallo Nero"></div>
          <div><label>Data incasso</label><input id="dataIncasso" type="date"></div>
          <div><label>Note</label><input id="note" type="text" placeholder="Annotazioni facoltative"></div>
          <div><label>Acconti periodo (€)</label><input id="accontiPeriodo" type="number" step="0.01" value="0"></div>
        </div>

        <div class="sep"></div>
        <div class="row4">
          <div><label>Quantità Slot</label><input id="qSlot" type="number" min="0" step="1" value="4"></div>
          <div><label>Quantità Cambiamonete</label><input id="qChg" type="number" min="0" step="1" value="1"></div>
          <div><label>Fondo per singola Slot (€)</label><input id="fondoSlotUnit" type="number" min="0" step="0.01" value="150"></div>
          <div><label>Fondo per singolo Cambiamonete (€)</label><input id="fondoChgUnit" type="number" min="0" step="0.01" value="1000"></div>
        </div>

        <div class="sep"></div>
        <!-- Parametri fiscali e ripartizione -->
        <div class="row4">
          <div><label>PREU % su IN</label><input id="preuPerc" type="number" step="0.1" value="24"></div>
          <div><label>AAMS % su IN</label><input id="aamsPerc" type="number" step="0.1" value="0.8"></div>
          <div><label>Rete % su IN</label><input id="retePerc" type="number" step="0.1" value="1"></div>
          <div><label>% Esercente su Netto</label><input id="percEsercente" type="number" step="0.1" value="50"></div>
        </div>

        <div class="sep"></div>
        <div class="stat-badges">
          <span class="badge">Fondi Slot: <b id="bFondiSlot">€ 0,00</b></span>
          <span class="badge">Fondi Cambia: <b id="bFondiChg">€ 0,00</b></span>
          <span class="badge">Σ Fondi: <b id="bFondiTot">€ 0,00</b></span>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="applyQuant">Applica quantità</button>
          <button class="btn" id="applyFunds">Applica fondi unitari</button>
          <button class="btn" id="demo">Demo</button>
          <button class="btn" id="save">Salva JSON</button>
          <button class="btn" id="load">Carica JSON</button>
          <button class="btn" id="reset">Reset</button>
          <input id="fileJson" type="file" accept="application/json" style="display:none">
        </div>
      </section>

      <!-- RIEPILOGO -->
      <section class="card">
        <h2>Riepilogo</h2>
        <table>
          <tbody>
            <tr><td class="muted">Totale fondi Slot</td><td id="totFondiSlot" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Totale fondi Cambiamonete</td><td id="totFondiChg" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Totale fondi (Slot + Cambia)</td><td id="totFondi" style="text-align:right">€ 0,00</td></tr>
          </tbody>
        </table>
        <div class="sep"></div>
        <table>
          <tbody>
            <tr><td class="muted">Somma monete Slot</td><td id="sumMoneteSlot" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Somma monete Cambia</td><td id="sumMoneteChg" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Somma banconote Cambia</td><td id="sumBancChg" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Altre monete + banconote</td><td id="sumAltre" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Acconti periodo</td><td id="sumAcconti" style="text-align:right">€ 0,00</td></tr>
            <tr><td class="muted">Somma utili lordi (ΣIN−ΣOUT)</td><td id="sumUtili" style="text-align:right">€ 0,00</td></tr>
            <tr><td><b>Incasso Virtuale</b></td><td id="virtual" style="text-align:right"><b>€ 0,00</b></td></tr>
          </tbody>
        </table>
      </section>

      <!-- SLOT -->
      <section class="card" style="grid-column:1 / -1">
        <h2>Slot (Monete + IN/OUT)</h2>
        <div class="muted" style="margin-bottom:6px">Inserisci <b>Monete</b>, <b>IN</b>, <b>OUT</b>. L’utile lordo = IN − OUT.</div>
        <div style="overflow:auto">
          <table id="tblSlot">
            <thead>
              <tr>
                <th>#</th>
                <th>Monete (€)</th>
                <th>IN (€)</th>
                <th>OUT (€)</th>
                <th>Utile (€)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td class="muted">Somme</td>
                <td id="sumMoneteSlot_f" style="text-align:right">€ 0,00</td>
                <td id="sumIn_f" style="text-align:right">€ 0,00</td>
                <td id="sumOut_f" style="text-align:right">€ 0,00</td>
                <td id="sumUtile_f" style="text-align:right">€ 0,00</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="sep"></div>
        <div class="row3">
          <div><label>Altre monete (€)</label><input id="altreMonete" type="number" step="0.01" value="0"></div>
          <div><label>Altre banconote (€)</label><input id="altreBanconote" type="number" step="0.01" value="0"></div>
          <div><label>Totale extra</label><input id="sumExtraView" type="text" value="€ 0,00" disabled></div>
        </div>
      </section>

      <!-- CAMBIAMONETE -->
      <section class="card" style="grid-column:1 / -1">
        <h2>Cambiamonete</h2>
        <div style="overflow:auto">
          <table id="tblChg">
            <thead>
              <tr>
                <th>#</th>
                <th>Fondo (€)</th>
                <th>Monete (€)</th>
                <th>Banconote (€)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td class="muted">Somme</td>
                <td id="sumFondoChg_f" style="text-align:right">€ 0,00</td>
                <td id="sumMoneteChg_f" style="text-align:right">€ 0,00</td>
                <td id="sumBancChg_f" style="text-align:right">€ 0,00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- RIPARTIZIONE -->
      <section class="card" style="grid-column:1 / -1">
        <h2>Ripartizione (PREU/AAMS/Rete su IN)</h2>
        <div class="row4">
          <div><label>Totale IN</label><input id="rip_IN" type="text" disabled></div>
          <div><label>Totale OUT</label><input id="rip_OUT" type="text" disabled></div>
          <div><label>Utile lordo (IN−OUT)</label><input id="rip_UTILE" type="text" disabled></div>
          <div><label>Tasse totali</label><input id="rip_TASSE" type="text" disabled></div>
        </div>
        <div class="row4" style="margin-top:10px">
          <div><label>PREU calcolato</label><input id="rip_PREU" type="text" disabled></div>
          <div><label>AAMS calcolato</label><input id="rip_AAMS" type="text" disabled></div>
          <div><label>Rete calcolata</label><input id="rip_RETE" type="text" disabled></div>
          <div><label>Netto da ripartire</label><input id="rip_NETTO" type="text" disabled></div>
        </div>
        <div class="row3" style="margin-top:10px">
          <div><label>% Esercente</label><input id="rip_PERC_ES" type="text" disabled></div>
          <div><label>Verso Esercente</label><input id="rip_ES" type="text" disabled></div>
          <div><label>Verso Gestore</label><input id="rip_GE" type="text" disabled></div>
        </div>
      </section>

      <!-- ANTEPRIMA TICKET -->
      <section class="card ticket-preview-wrap" id="ticketPreviewWrap" style="grid-column:1 / -1">
        <h2>Anteprima ticket 58 mm</h2>
        <div class="ticket-preview" id="ticketPreview"></div>
      </section>
    </div>
  </div>

  <!-- Ticket solo per stampa -->
  <div class="ticket-print">
    <div id="ticketPrint"></div>
  </div>

<script>
  // ===== Helpers =====
  const $ = (s)=> document.querySelector(s);
  const toNum = (v)=> {
    if (v===null || v===undefined) return 0;
    return parseFloat(String(v).replace(',','.')) || 0;
  };
  const eur = (n)=> new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format((+n||0).toFixed(2));

  // Elements
  const nomeLocale=$('#nomeLocale'), dataIncasso=$('#dataIncasso'), note=$('#note'), accontiPeriodo=$('#accontiPeriodo');
  const qSlot=$('#qSlot'), qChg=$('#qChg'), fondoSlotUnit=$('#fondoSlotUnit'), fondoChgUnit=$('#fondoChgUnit');
  const preuPerc=$('#preuPerc'), aamsPerc=$('#aamsPerc'), retePerc=$('#retePerc'), percEsercente=$('#percEsercente');

  const tblSlot=$('#tblSlot tbody'), tblChg=$('#tblChg tbody');
  const sumExtraView=$('#sumExtraView'), altreMonete=$('#altreMonete'), altreBanconote=$('#altreBanconote');

  // Summary fields
  const totFondiSlot=$('#totFondiSlot'), totFondiChg=$('#totFondiChg'), totFondi=$('#totFondi');
  const sumMoneteSlot=$('#sumMoneteSlot'), sumMoneteChg=$('#sumMoneteChg'), sumBancChg=$('#sumBancChg');
  const sumAltre=$('#sumAltre'), sumAcconti=$('#sumAcconti'), sumUtili=$('#sumUtili'), virtualEl=$('#virtual');

  const sumMoneteSlot_f=$('#sumMoneteSlot_f'), sumIn_f=$('#sumIn_f'), sumOut_f=$('#sumOut_f'), sumUtile_f=$('#sumUtile_f');
  const sumFondoChg_f=$('#sumFondoChg_f'), sumMoneteChg_f=$('#sumMoneteChg_f'), sumBancChg_f=$('#sumBancChg_f');

  const bFondiSlot=$('#bFondiSlot'), bFondiChg=$('#bFondiChg'), bFondiTot=$('#bFondiTot');
  const diffPill=$('#diffPill'), subInfo=$('#subInfo');

  // Ripartizione fields
  const rip_IN=$('#rip_IN'), rip_OUT=$('#rip_OUT'), rip_UTILE=$('#rip_UTILE'), rip_TASSE=$('#rip_TASSE');
  const rip_PREU=$('#rip_PREU'), rip_AAMS=$('#rip_AAMS'), rip_RETE=$('#rip_RETE'), rip_NETTO=$('#rip_NETTO');
  const rip_PERC_ES=$('#rip_PERC_ES'), rip_ES=$('#rip_ES'), rip_GE=$('#rip_GE');

  const ticketPreviewWrap=$('#ticketPreviewWrap'), ticketPreview=$('#ticketPreview'), ticketPrint=$('#ticketPrint');

  // Buttons
  $('#applyQuant').addEventListener('click', ()=>{ buildTables(); calc(); persist(); });
  $('#applyFunds').addEventListener('click', applyFundsToRows);
  $('#demo').addEventListener('click', demo);
  $('#save').addEventListener('click', saveJson);
  $('#load').addEventListener('click', ()=> $('#fileJson').click());
  $('#fileJson').addEventListener('change', handleJsonFile);
  $('#reset').addEventListener('click', ()=>{ localStorage.removeItem('iv58_state_v3'); location.reload(); });

  $('#btnPreview').addEventListener('click', ()=>{ ticketPreviewWrap.style.display='block'; renderTicket(ticketPreview); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); });
  $('#btnPrint').addEventListener('click', ()=>{ renderTicket(ticketPrint); window.print(); });

  nomeLocale.addEventListener('input', updateSub);
  dataIncasso.addEventListener('input', updateSub);
  function updateSub(){
    const d = dataIncasso.value ? new Date(dataIncasso.value+'T00:00:00').toLocaleDateString('it-IT') : '—';
    subInfo.textContent = `Locale: ${nomeLocale.value||'—'} • Data: ${d}`;
    persist();
  }

  // ===== Build dynamic tables =====
  function buildTables(){
    // Slots
    const nS = Math.max(0, parseInt(qSlot.value||0));
    tblSlot.innerHTML = '';
    for(let i=0;i<nS;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">S${i+1}</td>
        <td><input type="number" step="0.01" min="0" value="0" data-k="monete"></td>
        <td><input type="number" step="0.01" min="0" value="0" data-k="in"></td>
        <td><input type="number" step="0.01" min="0" value="0" data-k="out"></td>
        <td style="text-align:right" data-k="utile">€ 0,00</td>
      `;
      tblSlot.appendChild(tr);
    }
    // Cambiamonete
    const nC = Math.max(0, parseInt(qChg.value||0));
    tblChg.innerHTML = '';
    for(let i=0;i<nC;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">C${i+1}</td>
        <td><input type="number" step="0.01" min="0" value="${fondoChgUnit.value||0}" data-k="fondo"></td>
        <td><input type="number" step="0.01" min="0" value="0" data-k="monete"></td>
        <td><input type="number" step="0.01" min="0" value="0" data-k="banconote"></td>
      `;
      tblChg.appendChild(tr);
    }
    // Attach listeners
    document.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{ calc(); persist(); });
    });
  }

  function applyFundsToRows(){
    const unitChg = toNum(fondoChgUnit.value);
    tblChg.querySelectorAll('tr').forEach(tr=>{
      const f = tr.querySelector('input[data-k="fondo"]');
      if(f) f.value = unitChg.toFixed(2);
    });
    calc(); persist();
  }

  // ===== Core calculation =====
  function calc(){
    // Slot sums
    const slotRows = [...tblSlot.querySelectorAll('tr')];
    let sMon=0, sIn=0, sOut=0, sUtile=0;
    slotRows.forEach(r=>{
      const vM = toNum(r.querySelector('input[data-k="monete"]').value);
      const vI = toNum(r.querySelector('input[data-k="in"]').value);
      const vO = toNum(r.querySelector('input[data-k="out"]').value);
      const u = vI - vO;
      r.querySelector('[data-k="utile"]').textContent = eur(u);
      sMon += vM; sIn += vI; sOut += vO; sUtile += u;
    });

    // Cambiamonete sums
    const chgRows = [...tblChg.querySelectorAll('tr')];
    let sumFondoC=0, sumMonC=0, sumBanC=0;
    chgRows.forEach(r=>{
      sumFondoC += toNum(r.querySelector('input[data-k="fondo"]').value);
      sumMonC   += toNum(r.querySelector('input[data-k="monete"]').value);
      sumBanC   += toNum(r.querySelector('input[data-k="banconote"]').value);
    });

    // Extra
    const altM = toNum(altreMonete.value);
    const altB = toNum(altreBanconote.value);
    const acc  = toNum(accontiPeriodo.value);
    sumExtraView.value = eur(altM + altB);

    // Fondi
    const totFondoS = toNum(fondoSlotUnit.value) * Math.max(0, parseInt(qSlot.value||0));
    const totFondiAll = totFondoS + sumFondoC;

    // Disponibilità fisica + acconti
    const sommaValori = sMon + sumMonC + sumBanC + altM + altB + acc;

    // Incasso Virtuale
    const incassoVirtuale = sommaValori - totFondiAll - sUtile;

    // ===== Riepilogo UI =====
    sumMoneteSlot_f.textContent = eur(sMon);
    sumIn_f.textContent         = eur(sIn);
    sumOut_f.textContent        = eur(sOut);
    sumUtile_f.textContent      = eur(sUtile);

    sumFondoChg_f.textContent   = eur(sumFondoC);
    sumMoneteChg_f.textContent  = eur(sumMonC);
    sumBancChg_f.textContent    = eur(sumBanC);

    totFondiSlot.textContent = eur(totFondoS);
    totFondiChg.textContent  = eur(sumFondoC);
    totFondi.textContent     = eur(totFondiAll);

    sumMoneteSlot.textContent = eur(sMon);
    sumMoneteChg.textContent  = eur(sumMonC);
    sumBancChg.textContent    = eur(sumBanC);
    sumAltre.textContent      = eur(altM + altB);
    sumAcconti.textContent    = eur(acc);
    sumUtili.textContent      = eur(sUtile);
    virtualEl.textContent     = eur(incassoVirtuale);

    bFondiSlot.textContent = eur(totFondoS);
    bFondiChg.textContent  = eur(sumFondoC);
    bFondiTot.textContent  = eur(totFondoS + sumFondoC);

    diffPill.className = 'pill ' + (incassoVirtuale>0 ? 'pos' : (incassoVirtuale<0 ? 'neg' : 'neu'));
    diffPill.textContent =
      Math.abs(incassoVirtuale) < 0.005 ? 'OK — Zero' :
      (incassoVirtuale>0 ? 'Crescono ' + eur(incassoVirtuale) : 'Mancano ' + eur(incassoVirtuale));

    // ===== Ripartizione =====
    // Aliquote su IN
    const preu = sIn * toNum(preuPerc.value) / 100;
    const aams = sIn * toNum(aamsPerc.value) / 100;
    const rete = sIn * toNum(retePerc.value) / 100;
    const tasseTot = preu + aams + rete;

    const netto = (sIn - sOut) - tasseTot;
    const pEs = Math.max(0, Math.min(100, toNum(percEsercente.value)));
    const quotaEs = netto * pEs / 100;
    const quotaGe = netto - quotaEs;

    // Aggiorna campi ripartizione
    rip_IN.value    = eur(sIn);
    rip_OUT.value   = eur(sOut);
    rip_UTILE.value = eur(sIn - sOut);
    rip_PREU.value  = eur(preu);
    rip_AAMS.value  = eur(aams);
    rip_RETE.value  = eur(rete);
    rip_TASSE.value = eur(tasseTot);
    rip_NETTO.value = eur(nett o);
    rip_PERC_ES.value = pEs.toFixed(1) + ' %';
    rip_ES.value    = eur(quotaEs);
    rip_GE.value    = eur(quotaGe);
  }

  // ===== Ticket (58mm) =====
  function renderTicket(container){
    const D = (dataIncasso.value ? new Date(dataIncasso.value+'T00:00:00') : new Date()).toLocaleDateString('it-IT');

    // Rileggi i totali dalla UI
    const v = {
      monSlot:   sumMoneteSlot.textContent,
      monChg:    sumMoneteChg.textContent,
      banChg:    sumBancChg.textContent,
      fondiSlot: totFondiSlot.textContent,
      fondiChg:  totFondiChg.textContent,
      fondiTot:  totFondi.textContent,
      extra:     sumAltre.textContent,
      acconti:   sumAcconti.textContent,
      utili:     sumUtili.textContent,
      incasso:   virtualEl.textContent,
      pill:      diffPill.textContent,

      IN:   rip_IN.value, OUT: rip_OUT.value,
      UT:   rip_UTILE.value, TASSE: rip_TASSE.value,
      PREU: rip_PREU.value, AAMS: rip_AAMS.value, RETE: rip_RETE.value,
      NETTO: rip_NETTO.value, PERC: rip_PERC_ES.value,
      ES: rip_ES.value, GE: rip_GE.value
    };

    const slotRows = [...tblSlot.querySelectorAll('tr')].map((r,i)=>{
      const M = eur(toNum(r.querySelector('input[data-k="monete"]').value));
      const I = eur(toNum(r.querySelector('input[data-k="in"]').value));
      const O = eur(toNum(r.querySelector('input[data-k="out"]').value));
      const U = r.querySelector('[data-k="utile"]').textContent;
      return `
        <div class="t-row"><span>S${i+1} Monete</span><b>${M}</b></div>
        <div class="t-row"><span>IN / OUT</span><b>${I} / ${O}</b></div>
        <div class="t-row"><span>Utile</span><b>${U}</b></div>
      `;
    }).join('');

    const chgRows = [...tblChg.querySelectorAll('tr')].map((r,i)=>{
      const F = eur(toNum(r.querySelector('input[data-k="fondo"]').value));
      const M = eur(toNum(r.querySelector('input[data-k="monete"]').value));
      const B = eur(toNum(r.querySelector('input[data-k="banconote"]').value));
      return `
        <div class="t-row"><span>C${i+1} Fondo</span><b>${F}</b></div>
        <div class="t-row"><span>Monete / Banconote</span><b>${M} / ${B}</b></div>
      `;
    }).join('');

    const noteHtml = note.value ? `<div class="t-note"><b>Note:</b> ${note.value}</div>` : '';

    const html = `
      <div class="t-head">
        <div class="title">${(nomeLocale.value || 'INCASSO VIRTUALE').toUpperCase()}</div>
        <div class="sub">Data: ${D}</div>
      </div>

      <div class="t-sec">
        <h4>Slot</h4>
        ${slotRows || `<div class="t-row"><span>—</span><b>€ 0,00</b></div>`}
        <div class="t-row"><span><b>Somma monete</b></span><b>${v.monSlot}</b></div>
      </div>

      <div class="t-sec">
        <h4>Cambiamonete</h4>
        ${chgRows || `<div class="t-row"><span>—</span><b>€ 0,00</b></div>`}
        <div class="t-row"><span><b>Fondi cambia</b></span><b>${v.fondiChg}</b></div>
        <div class="t-row"><span><b>Monete cambia</b></span><b>${v.monChg}</b></div>
        <div class="t-row"><span><b>Banconote cambia</b></span><b>${v.banChg}</b></div>
      </div>

      <div class="t-sec">
        <h4>Extra</h4>
        <div class="t-row"><span>Altre monete + banconote</span><b>${v.extra}</b></div>
        <div class="t-row"><span>Acconti periodo</span><b>${v.acconti}</b></div>
      </div>

      <div class="t-sec">
        <h4>Ripartizione</h4>
        <div class="t-row"><span>Totale IN</span><b>${v.IN}</b></div>
        <div class="t-row"><span>Totale OUT</span><b>${v.OUT}</b></div>
        <div class="t-row"><span>Utile lordo</span><b>${v.UT}</b></div>
        <div class="t-row"><span>PREU</span><b>${v.PREU}</b></div>
        <div class="t-row"><span>AAMS</span><b>${v.AAMS}</b></div>
        <div class="t-row"><span>Rete</span><b>${v.RETE}</b></div>
        <div class="t-row"><span><b>Tasse totali</b></span><b><b>${v.TASSE}</b></div>
        <div class="t-row"><span><b>Netto da ripartire</b></span><b><b>${v.NETTO}</b></div>
        <div class="t-row"><span>% Esercente</span><b>${v.PERC}</b></div>
        <div class="t-row"><span><b>Verso Esercente</b></span><b><b>${v.ES}</b></div>
        <div class="t-row"><span>Verso Gestore</span><b>${v.GE}</b></div>
      </div>

      <div class="t-sec">
        <h4>Controllo Virtuale</h4>
        <div class="t-row"><span>Σ Fondi</span><b>${v.fondiTot}</b></div>
        <div class="t-row"><span>Σ(IN−OUT)</span><b>${v.utili}</b></div>
        <div class="t-row"><span><b>Incasso Virtuale</b></span><b><b>${v.incasso}</b></div>
        <div class="t-emph">${v.pill}</div>
        ${noteHtml}
        <div class="t-foot">Operatore: ______________________</div>
      </div>
    `;

    container.innerHTML = `<div class="ticket-preview">${html}</div>`;
    if (container === ticketPrint){
      container.innerHTML = `<div class="ticket-preview" style="border:0; box-shadow:none">${html}</div>`;
    }
  }

  // ===== Persistence (LocalStorage + JSON) =====
  function capture(){
    const slots=[...tblSlot.querySelectorAll('tr')].map(r=>({
      monete: toNum(r.querySelector('input[data-k="monete"]').value),
      in:     toNum(r.querySelector('input[data-k="in"]').value),
      out:    toNum(r.querySelector('input[data-k="out"]').value)
    }));
    const chg=[...tblChg.querySelectorAll('tr')].map(r=>({
      fondo:     toNum(r.querySelector('input[data-k="fondo"]').value),
      monete:    toNum(r.querySelector('input[data-k="monete"]').value),
      banconote: toNum(r.querySelector('input[data-k="banconote"]').value)
    }));
    return {
      meta:{locale:nomeLocale.value||'', data:dataIncasso.value||'', note:note.value||''},
      qSlot: toNum(qSlot.value), qChg: toNum(qChg.value),
      fondoSlotUnit: toNum(fondoSlotUnit.value), fondoChgUnit: toNum(fondoChgUnit.value),
      preu: toNum(preuPerc.value), aams: toNum(aamsPerc.value), rete: toNum(retePerc.value),
      percEs: toNum(percEsercente.value),
      slots, chg,
      altreMonete: toNum(altreMonete.value), altreBanconote: toNum(altreBanconote.value),
      accontiPeriodo: toNum(accontiPeriodo.value)
    };
  }
  function apply(state){
    qSlot.value = state.qSlot||0; qChg.value = state.qChg||0;
    fondoSlotUnit.value = state.fondoSlotUnit||0; fondoChgUnit.value = state.fondoChgUnit||0;
    preuPerc.value = state.preu ?? 24; aamsPerc.value = state.aams ?? 0.8; retePerc.value = state.rete ?? 1;
    percEsercente.value = state.percEs ?? 50;
    buildTables();
    const sR=[...tblSlot.querySelectorAll('tr')];
    (state.slots||[]).forEach((v,i)=>{ if(!sR[i]) return;
      sR[i].querySelector('input[data-k="monete"]').value=v.monete||0;
      sR[i].querySelector('input[data-k="in"]').value=v.in||0;
      sR[i].querySelector('input[data-k="out"]').value=v.out||0;
    });
    const cR=[...tblChg.querySelectorAll('tr')];
    (state.chg||[]).forEach((v,i)=>{ if(!cR[i]) return;
      cR[i].querySelector('input[data-k="fondo"]').value=v.fondo||0;
      cR[i].querySelector('input[data-k="monete"]').value=v.monete||0;
      cR[i].querySelector('input[data-k="banconote"]').value=v.banconote||0;
    });
    altreMonete.value=state.altreMonete||0; altreBanconote.value=state.altreBanconote||0; accontiPeriodo.value=state.accontiPeriodo||0;
    nomeLocale.value=state.meta?.locale||''; dataIncasso.value=state.meta?.data||''; note.value=state.meta?.note||'';
    updateSub(); calc();
  }
  function persist(){ localStorage.setItem('iv58_state_v3', JSON.stringify(capture())); }
  function restore(){ const raw=localStorage.getItem('iv58_state_v3'); if(raw){ try{ apply(JSON.parse(raw)); return true; }catch{} } return false; }
  function saveJson(){
    const blob=new Blob([JSON.stringify(capture(),null,2)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='incasso-virtuale-58mm.json'; a.click(); URL.revokeObjectURL(url);
  }
  function handleJsonFile(e){
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload = ev=>{ try{ apply(JSON.parse(ev.target.result)); }catch{ alert('JSON non valido'); } };
    r.readAsText(f); e.target.value='';
  }

  // ===== Demo =====
  function demo(){
    qSlot.value=5; qChg.value=2; fondoSlotUnit.value=150; fondoChgUnit.value=1000;
    preuPerc.value=24; aamsPerc.value=0.8; retePerc.value=1; percEsercente.value=50;
    buildTables();
    const s=[{m:320,in:2100,out:1950},{m:280,in:1900,out:1800},{m:410,in:2600,out:2605},{m:150,in:1100,out:1000},{m:520,in:2900,out:2750}];
    [...tblSlot.querySelectorAll('tr')].forEach((r,i)=>{ const v=s[i]; if(!v) return;
      r.querySelector('input[data-k="monete"]').value=v.m;
      r.querySelector('input[data-k="in"]').value=v.in;
      r.querySelector('input[data-k="out"]').value=v.out;
    });
    const c=[{f:1000,mon:800,ban:1200},{f:1000,mon:600,ban:900}];
    [...tblChg.querySelectorAll('tr')].forEach((r,i)=>{ const v=c[i]; if(!v) return;
      r.querySelector('input[data-k="fondo"]').value=v.f;
      r.querySelector('input[data-k="monete"]').value=v.mon;
      r.querySelector('input[data-k="banconote"]').value=v.ban;
    });
    altreMonete.value=50; altreBanconote.value=100; accontiPeriodo.value=500;
    calc(); persist();
    ticketPreviewWrap.style.display='block'; renderTicket(ticketPreview);
  }

  // ===== Init =====
  (function init(){
    if(!restore()){ buildTables(); calc(); }
    updateSub();
  })();
</script>
</body>
</html>
