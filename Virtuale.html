<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Incasso Virtuale AWP ‚Äî 58mm</title>
<!-- Grafici: carico Chart.js da CDN (se offline mostra solo numeri) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f6f4ef; --panel:#ffffff; --ink:#222; --muted:#666;
  --line:#dcd8d0; --line-strong:#bdb7ad;
  --good:#106e2a; --bad:#a32228;
  --pill-pos-bg:#e7f6ec; --pill-pos-bd:#a6dbb5;
  --pill-neg-bg:#fdebec; --pill-neg-bd:#f0a1a5;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--ink);line-height:1.25}
h1,h2{margin:0}
.muted{color:var(--muted)}
/* Topbar */
.topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;
  background:linear-gradient(180deg,#fbfaf7,#f1eee8);border-bottom:1px solid var(--line);padding:10px 12px}
.brand h1{font-size:16px;margin:0}
#subInfo{font-size:12px;color:var(--muted)}
.pill{font-weight:800;font-size:13px;border-radius:999px;padding:6px 10px;border:1px solid var(--line)}
.pill.pos{background:var(--pill-pos-bg);border-color:var(--pill-pos-bd);color:var(--good)}
.pill.neg{background:var(--pill-neg-bg);border-color:var(--pill-neg-bd);color:var(--bad)}
.pill.neu{background:#eee;color:#333}
.btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:700}
.btn.primary{background:#eef3fb;color:#274b87;border-color:#c7d6f4}
label.tog{font-size:12px;margin-left:8px}
/* Hamburger + Sidebar */
.hamburger{font-size:22px;cursor:pointer;padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
.sidebar{position:fixed;left:-270px;top:0;width:270px;height:100%;background:#fff;box-shadow:2px 0 10px #0002;transition:.3s;z-index:40;padding:18px}
.sidebar.active{left:0}
.sidebar h3{margin:0 0 10px}
.sidebar a{display:block;text-decoration:none;color:#222;padding:8px 0;font-weight:700}
/* Layout */
.wrap{padding:12px;max-width:1120px;margin:auto}
.card{background:linear-gradient(180deg,var(--panel),#fdfcf9);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
.card h2{font-size:16px;margin:0 0 8px}
.row4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
@media(max-width:900px){.row4,.row3{grid-template-columns:1fr}}
input[type=text],input[type=number],input[type=date]{width:100%;padding:10px;border:1px solid #cfc8be;border-radius:10px;background:#fff;font-size:15px}
input:focus{outline:3px solid #d7e8ff;border-color:#b7cff1}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
th,td{padding:8px 6px;border-bottom:1px dashed var(--line);text-align:right}
td:first-child,th:first-child{text-align:left}
th{background:#f6f4f0;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
/* Modals */
.modal{display:none;position:fixed;inset:0;z-index:60;align-items:center;justify-content:center;background:#0008}
.modal.on{display:flex}
.modal .box{background:#fff;border-radius:10px;max-width:92vw;max-height:90vh;overflow:auto;padding:16px;border:1px solid var(--line)}
.modal .close{float:right;cursor:pointer;font-weight:900;font-size:20px}
.modal h2{margin-top:0}
.modal .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.modal .grid2{grid-template-columns:1fr}}
/* Ticket grafico preview */
.ticket{width:58mm;max-width:100%;background:#fff;color:#000;border:1px dashed var(--line-strong);border-radius:6px;padding:6mm 4mm}
.t-head{border:2px solid var(--line-strong);border-radius:6px;padding:6px;text-align:center;margin-bottom:6px}
.t-head .title{font-weight:800;font-size:14px}
.t-head .sub{font-size:11px;color:#333}
.t-sec{margin:6px 0}
.t-sec h4{margin:0 0 4px;font-size:12px;border-bottom:1px solid #bbb;padding-bottom:2px}
.t-row{display:flex;justify-content:space-between;font-size:12px;padding:1px 0}
.t-row b{font-weight:700}
.t-foot{border-top:2px dashed #999;margin-top:6px;padding-top:6px;font-size:12px}
.t-emph{border:2px solid #000;border-radius:4px;padding:4px;text-align:center;font-weight:800;margin-top:4px}
/* Print areas */
.print-area{display:none}
@page{size:58mm auto;margin:2mm}
@media print{
  body{background:#fff}
  .topbar,.wrap,.sidebar{display:none!important}
  .print-area.active{display:block!important}
}
pre.ticket-text{font-family:ui-monospace,SFMono-Regular,Consolas,"Courier New",monospace;font-size:12px;line-height:1.25;white-space:pre}
</style>
</head>
<body>
<!-- TOP -->
<div class="topbar">
  <div style="display:flex;align-items:center;gap:8px">
    <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
    <div class="brand">
      <h1>Incasso Virtuale AWP</h1>
      <div id="subInfo" class="muted" style="font-size:12px">Locale: ‚Äî ‚Ä¢ Data: ‚Äî</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
    <span id="diffPill" class="pill neu">‚Äî</span>
    <label class="tog"><input type="radio" name="mode" value="grafico" checked> Grafico</label>
    <label class="tog"><input type="radio" name="mode" value="testo"> Testo 32 col</label>
    <button id="btnPreview" class="btn">Anteprima</button>
    <button id="btnPrint" class="btn primary">Stampa</button>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <h3>Menu</h3>
  <a href="#" onclick="openModal('mAnteprima')">üìÑ Anteprima</a>
  <a href="#" onclick="openModal('mStats')">üìä Statistiche</a>
  <a href="#" onclick="openModal('mGuida')">‚ÑπÔ∏è Guida</a>
  <a href="#" onclick="openModal('mCreatore')">üë§ Creatore</a>
</aside>

<div class="wrap">
  <!-- DATI -->
  <section class="card">
    <h2>Dati</h2>
    <div class="row4">
      <div><label>Nome locale</label><input id="nomeLocale" placeholder="Es. Bar Gallo Nero"></div>
      <div><label>Data incasso</label><input id="dataIncasso" type="date"></div>
      <div><label>Note</label><input id="note" placeholder="Annotazioni facoltative"></div>
      <div><label>Acconti periodo (‚Ç¨)</label><input id="accontiPeriodo" type="number" step="0.01" value="0"></div>
    </div>
    <div class="row4" style="margin-top:8px">
      <div><label>Quantit√† Slot</label><input id="qSlot" type="number" min="0" step="1" value="4"></div>
      <div><label>Quantit√† Cambiamonete</label><input id="qChg" type="number" min="0" step="1" value="1"></div>
      <div><label>Fondo per singola Slot (‚Ç¨)</label><input id="fondoSlotUnit" type="number" min="0" step="0.01" value="150"></div>
      <div><label>Fondo per singolo Cambiamonete (‚Ç¨)</label><input id="fondoChgUnit" type="number" min="0" step="0.01" value="1000"></div>
    </div>
    <div class="row4" style="margin-top:8px">
      <div><label>PREU % su IN</label><input id="preuPerc" type="number" step="0.1" value="24"></div>
      <div><label>AAMS % su IN</label><input id="aamsPerc" type="number" step="0.1" value="0.8"></div>
      <div><label>Rete % su IN</label><input id="retePerc" type="number" step="0.1" value="1"></div>
      <div><label>% Esercente su Netto</label><input id="percEsercente" type="number" step="0.1" value="50"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="buildTables()">Applica quantit√†</button>
      <button class="btn" onclick="demo()">Demo</button>
      <span class="muted" style="font-size:12px">Tutto in RAM (nessun salvataggio)</span>
    </div>
  </section>

  <!-- SLOT -->
  <section class="card">
    <h2>Slot (Monete + IN/OUT)</h2>
    <div class="muted" style="margin-bottom:6px">Utile lordo = IN ‚àí OUT. Inserisci valori per ogni slot.</div>
    <div style="overflow:auto">
      <table id="tblSlot">
        <thead><tr><th>#</th><th>Monete (‚Ç¨)</th><th>IN (‚Ç¨)</th><th>OUT (‚Ç¨)</th><th>Utile (‚Ç¨)</th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="muted">Somme</td><td id="sumMoneteSlot_f">‚Ç¨ 0,00</td><td id="sumIn_f">‚Ç¨ 0,00</td><td id="sumOut_f">‚Ç¨ 0,00</td><td id="sumUtile_f">‚Ç¨ 0,00</td></tr>
        </tfoot>
      </table>
    </div>
    <div class="row3" style="margin-top:8px">
      <div><label>Altre monete (‚Ç¨)</label><input id="altreMonete" type="number" step="0.01" value="0"></div>
      <div><label>Altre banconote (‚Ç¨)</label><input id="altreBanconote" type="number" step="0.01" value="0"></div>
      <div><label>Totale extra</label><input id="sumExtraView" type="text" readonly value="‚Ç¨ 0,00"></div>
    </div>
  </section>

  <!-- CAMBIAMONETE -->
  <section class="card">
    <h2>Cambiamonete</h2>
    <div style="overflow:auto">
      <table id="tblChg">
        <thead><tr><th>#</th><th>Fondo (‚Ç¨)</th><th>Monete (‚Ç¨)</th><th>Banconote (‚Ç¨)</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td class="muted">Somme</td><td id="sumFondoChg_f">‚Ç¨ 0,00</td><td id="sumMoneteChg_f">‚Ç¨ 0,00</td><td id="sumBancChg_f">‚Ç¨ 0,00</td></tr></tfoot>
      </table>
    </div>
  </section>

  <!-- RIEPILOGO -->
  <section class="card">
    <h2>Riepilogo & Ripartizione</h2>
    <div class="row3">
      <div class="card" style="padding:10px">
        <h3 style="margin:0 0 6px;font-size:14px">Fondi e Valori</h3>
        <table>
          <tbody>
            <tr><td class="muted">Totale fondi Slot</td><td id="totFondiSlot">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Totale fondi Cambiamonete</td><td id="totFondiChg">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Œ£ Fondi</td><td id="totFondi">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Monete Slot</td><td id="sumMoneteSlot">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Monete Cambia</td><td id="sumMoneteChg">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Banconote Cambia</td><td id="sumBancChg">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Extra (mon+ban)</td><td id="sumAltre">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Acconti periodo</td><td id="sumAcconti">‚Ç¨ 0,00</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="padding:10px">
        <h3 style="margin:0 0 6px;font-size:14px">Utile e Virtuale</h3>
        <table>
          <tbody>
            <tr><td class="muted">Œ£ IN</td><td id="sumInView">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Œ£ OUT</td><td id="sumOutView">‚Ç¨ 0,00</td></tr>
            <tr><td class="muted">Œ£ Utile lordo (IN‚àíOUT)</td><td id="sumUtili">‚Ç¨ 0,00</td></tr>
            <tr><td><b>Incasso Virtuale</b></td><td id="virtual"><b>‚Ç¨ 0,00</b></td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="padding:10px">
        <h3 style="margin:0 0 6px;font-size:14px">Ripartizione su IN</h3>
        <table>
          <tbody>
            <tr><td>PREU</td><td id="rip_PREU">‚Ç¨ 0,00</td></tr>
            <tr><td>AAMS</td><td id="rip_AAMS">‚Ç¨ 0,00</td></tr>
            <tr><td>Rete</td><td id="rip_RETE">‚Ç¨ 0,00</td></tr>
            <tr><td><b>Tasse totali</b></td><td id="rip_TASSE"><b>‚Ç¨ 0,00</b></td></tr>
            <tr><td>Netto da ripartire</td><td id="rip_NETTO">‚Ç¨ 0,00</td></tr>
            <tr><td>% Esercente</td><td id="rip_PERC_ES">50.0 %</td></tr>
            <tr><td><b>Verso Esercente</b></td><td id="rip_ES"><b>‚Ç¨ 0,00</b></td></tr>
            <tr><td>Verso Gestore</td><td id="rip_GE">‚Ç¨ 0,00</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- MODALS -->
<div class="modal" id="mAnteprima"><div class="box">
  <span class="close" onclick="closeModal('mAnteprima')">‚úñ</span>
  <h2>Anteprima di stampa</h2>
  <div id="previewArea"></div>
</div></div>

<div class="modal" id="mStats"><div class="box">
  <span class="close" onclick="closeModal('mStats')">‚úñ</span>
  <h2>Statistiche</h2>
  <div id="statsText" class="muted" style="margin:6px 0 12px"></div>
  <div class="grid2">
    <div><canvas id="chartInOut"></canvas></div>
    <div><canvas id="chartRip"></canvas></div>
  </div>
  <div style="margin-top:12px"><canvas id="chartPayout"></canvas></div>
  <div id="statsFallback" class="muted" style="display:none;margin-top:8px">Grafici non disponibili (offline). Ecco i numeri sopra.</div>
</div></div>

<div class="modal" id="mGuida"><div class="box">
  <span class="close" onclick="closeModal('mGuida')">‚úñ</span>
  <h2>Guida rapida</h2>
  <ol>
    <li>Imposta quantit√† Slot e Cambiamonete e i fondi unitari.</li>
    <li>Compila per ogni Slot: <b>Monete</b>, <b>IN</b>, <b>OUT</b>.</li>
    <li>Compila per ogni Cambiamonete: <b>Fondo</b>, <b>Monete</b>, <b>Banconote</b>.</li>
    <li>Aggiungi <b>Altre monete/banconote</b> (eventuali) e <b>Acconti periodo</b>.</li>
    <li>Verifica la pillola in alto: <b>Mancano / Crescono / OK</b>.</li>
    <li>Toggle ‚ÄúGrafico / Testo 32 col‚Äù e poi <b>Anteprima</b> o <b>Stampa</b>.</li>
  </ol>
  <p class="muted">‚ÄúIncasso Virtuale‚Äù = (Monete Slot + Monete Cambia + Banconote Cambia + Extra + Acconti) ‚àí (Fondi Slot + Fondi Cambia) ‚àí Œ£(Utile lordo per slot).</p>
</div></div>

<div class="modal" id="mCreatore"><div class="box">
  <span class="close" onclick="closeModal('mCreatore')">‚úñ</span>
  <h2>Info sul creatore</h2>
  <p>App realizzata da <b>Stephan Winckler</b>, tecnico specializzato 2025.</p>
</div></div>

<!-- PRINT AREAS -->
<div id="printGraph" class="print-area"></div>
<div id="printText" class="print-area"></div>

<script>
/* ===== Helpers ===== */
const $ = (s)=> document.querySelector(s);
const toNum = (v)=>{ if(v===null||v===undefined) return 0; return parseFloat(String(v).replace(',','.'))||0; };
const eur = (n)=> new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format((+n||0).toFixed(2));
function toggleSidebar(){ $('#sidebar').classList.toggle('active'); }
function openModal(id){ $('#'+id).classList.add('on'); if(id==='mAnteprima') renderPreview(); if(id==='mStats') renderStats(); }
function closeModal(id){ $('#'+id).classList.remove('on'); }

/* ===== Elements ===== */
const nomeLocale=$('#nomeLocale'), dataIncasso=$('#dataIncasso'), note=$('#note'), accontiPeriodo=$('#accontiPeriodo');
const qSlot=$('#qSlot'), qChg=$('#qChg'), fondoSlotUnit=$('#fondoSlotUnit'), fondoChgUnit=$('#fondoChgUnit');
const preuPerc=$('#preuPerc'), aamsPerc=$('#aamsPerc'), retePerc=$('#retePerc'), percEsercente=$('#percEsercente');

const subInfo=$('#subInfo'), diffPill=$('#diffPill');

const tblSlotBody = $('#tblSlot tbody');
const tblChgBody  = $('#tblChg tbody');

/* Riepilogo fields */
const totFondiSlot=$('#totFondiSlot'), totFondiChg=$('#totFondiChg'), totFondi=$('#totFondi');
const sumMoneteSlot=$('#sumMoneteSlot'), sumMoneteChg=$('#sumMoneteChg'), sumBancChg=$('#sumBancChg');
const sumAltre=$('#sumAltre'), sumAcconti=$('#sumAcconti'), sumUtili=$('#sumUtili'), virtualEl=$('#virtual');
const sumMoneteSlot_f=$('#sumMoneteSlot_f'), sumIn_f=$('#sumIn_f'), sumOut_f=$('#sumOut_f');
const sumFondoChg_f=$('#sumFondoChg_f'), sumMoneteChg_f=$('#sumMoneteChg_f'), sumBancChg_f=$('#sumBancChg_f');
const sumInView=$('#sumInView'), sumOutView=$('#sumOutView');

/* Ripartizione fields */
const rip_PREU=$('#rip_PREU'), rip_AAMS=$('#rip_AAMS'), rip_RETE=$('#rip_RETE'), rip_TASSE=$('#rip_TASSE');
const rip_NETTO=$('#rip_NETTO'), rip_PERC_ES=$('#rip_PERC_ES'), rip_ES=$('#rip_ES'), rip_GE=$('#rip_GE');

/* Build tables */
function buildTables(){
  // Slot rows
  tblSlotBody.innerHTML = '';
  const nS = Math.max(0, parseInt(qSlot.value||0));
  for(let i=0;i<nS;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="muted">S${i+1}</td>
      <td><input type="number" step="0.01" value="0" data-k="monete"></td>
      <td><input type="number" step="0.01" value="0" data-k="in"></td>
      <td><input type="number" step="0.01" value="0" data-k="out"></td>
      <td data-k="utile" style="text-align:right">‚Ç¨ 0,00</td>`;
    tblSlotBody.appendChild(tr);
  }
  // Changer rows
  tblChgBody.innerHTML = '';
  const nC = Math.max(0, parseInt(qChg.value||0));
  for(let i=0;i<nC;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="muted">C${i+1}</td>
      <td><input type="number" step="0.01" value="${fondoChgUnit.value||0}" data-k="fondo"></td>
      <td><input type="number" step="0.01" value="0" data-k="monete"></td>
      <td><input type="number" step="0.01" value="0" data-k="banconote"></td>`;
    tblChgBody.appendChild(tr);
  }
  bindInputs();
  calc();
}
function bindInputs(){
  document.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input',()=>{ updateSub(); calc(); });
  });
}
function updateSub(){
  const d = dataIncasso.value ? new Date(dataIncasso.value+'T00:00:00').toLocaleDateString('it-IT') : '‚Äî';
  subInfo.textContent = `Locale: ${nomeLocale.value||'‚Äî'} ‚Ä¢ Data: ${d}`;
}

/* Core calc */
function calc(){
  // Sum Slots
  const rowsS = [...tblSlotBody.querySelectorAll('tr')];
  let sMon=0,sIn=0,sOut=0,sUtile=0;
  rowsS.forEach(r=>{
    const vM=toNum(r.querySelector('input[data-k="monete"]').value);
    const vI=toNum(r.querySelector('input[data-k="in"]').value);
    const vO=toNum(r.querySelector('input[data-k="out"]').value);
    const u=vI-vO;
    r.querySelector('[data-k="utile"]').textContent = eur(u);
    sMon+=vM; sIn+=vI; sOut+=vO; sUtile+=u;
  });

  // Sum Changers
  const rowsC = [...tblChgBody.querySelectorAll('tr')];
  let fC=0,mC=0,bC=0;
  rowsC.forEach(r=>{
    fC+=toNum(r.querySelector('input[data-k="fondo"]').value);
    mC+=toNum(r.querySelector('input[data-k="monete"]').value);
    bC+=toNum(r.querySelector('input[data-k="banconote"]').value);
  });

  // Extra
  const altM=toNum($('#altreMonete')?.value||0);
  const altB=toNum($('#altreBanconote')?.value||0);
  const acc =toNum(accontiPeriodo.value);
  $('#sumExtraView').value = eur(altM+altB);

  // Fondi
  const totFondoS = toNum(fondoSlotUnit.value) * Math.max(0, parseInt(qSlot.value||0));
  const totFondiAll = totFondoS + fC;

  // Controllo virtuale
  const sommaValori = sMon + mC + bC + altM + altB + acc;
  const incassoVirtuale = sommaValori - totFondiAll - sUtile;

  // Update summaries
  sumMoneteSlot_f.textContent = eur(sMon);
  sumIn_f.textContent         = eur(sIn);
  sumOut_f.textContent        = eur(sOut);
  $('#sumUtile_f').textContent= eur(sUtile);
  sumFondoChg_f.textContent   = eur(fC);
  sumMoneteChg_f.textContent  = eur(mC);
  sumBancChg_f.textContent    = eur(bC);

  totFondiSlot.textContent = eur(totFondoS);
  totFondiChg.textContent  = eur(fC);
  totFondi.textContent     = eur(totFondiAll);
  sumMoneteSlot.textContent= eur(sMon);
  sumMoneteChg.textContent = eur(mC);
  sumBancChg.textContent   = eur(bC);
  sumAltre.textContent     = eur(altM + altB);
  sumAcconti.textContent   = eur(acc);
  sumUtili.textContent     = eur(sUtile);
  sumInView.textContent    = eur(sIn);
  sumOutView.textContent   = eur(sOut);
  virtualEl.textContent    = eur(incassoVirtuale);

  // Pill
  diffPill.className = 'pill ' + (incassoVirtuale>0?'pos':(incassoVirtuale<0?'neg':'neu'));
  diffPill.textContent = Math.abs(incassoVirtuale)<0.005 ? 'OK ‚Äî Zero' : (incassoVirtuale>0 ? 'Crescono '+eur(incassoVirtuale) : 'Mancano '+eur(incassoVirtuale));

  // Ripartizione su IN
  const preu = sIn * toNum(preuPerc.value)/100;
  const aams = sIn * toNum(aamsPerc.value)/100;
  const rete = sIn * toNum(retePerc.value)/100;
  const tasse= preu + aams + rete;
  const netto = (sIn - sOut) - tasse;
  const pEs = Math.max(0,Math.min(100,toNum(percEsercente.value)));
  const qEs = netto * pEs/100;
  const qGe = netto - qEs;

  rip_PREU.textContent  = eur(preu);
  rip_AAMS.textContent  = eur(aams);
  rip_RETE.textContent  = eur(rete);
  rip_TASSE.textContent = eur(tasse);
  rip_NETTO.textContent = eur(netto);
  rip_PERC_ES.textContent = pEs.toFixed(1)+' %';
  rip_ES.textContent    = eur(qEs);
  rip_GE.textContent    = eur(qGe);

  // cache for previews/stats
  window._calc = {rowsS,rowsC,sMon,sIn,sOut,sUtile,fC,mC,bC,altM,altB,acc,totFondoS,totFondiAll,sommaValori,incassoVirtuale,preu,aams,rete,tasse,netto,pEs,qEs,qGe};
}

/* Demo data */
function demo(){
  qSlot.value=5; qChg.value=2; fondoSlotUnit.value=150; fondoChgUnit.value=1000;
  buildTables();
  const s = [
    {m:320,in:2100,out:1950},{m:280,in:1900,out:1800},{m:410,in:2600,out:2605},
    {m:150,in:1100,out:1000},{m:520,in:2900,out:2750}
  ];
  [...tblSlotBody.querySelectorAll('tr')].forEach((r,i)=>{ const v=s[i]; if(!v) return;
    r.querySelector('input[data-k="monete"]').value=v.m;
    r.querySelector('input[data-k="in"]').value=v.in;
    r.querySelector('input[data-k="out"]').value=v.out;
  });
  const c=[{f:1000,mon:800,ban:1200},{f:1000,mon:600,ban:900}];
  [...tblChgBody.querySelectorAll('tr')].forEach((r,i)=>{ const v=c[i]; if(!v) return;
    r.querySelector('input[data-k="fondo"]').value=v.f;
    r.querySelector('input[data-k="monete"]').value=v.mon;
    r.querySelector('input[data-k="banconote"]').value=v.ban;
  });
  $('#altreMonete').value=50; $('#altreBanconote').value=100; accontiPeriodo.value=500;
  preuPerc.value=24; aamsPerc.value=0.8; retePerc.value=1; percEsercente.value=50;
  calc();
}

/* ===== Anteprima (modal topbar + menu voce) ===== */
$('#btnPreview').addEventListener('click', ()=> openModal('mAnteprima'));
$('#btnPrint').addEventListener('click', printTicket);

function currentMode(){ return document.querySelector('input[name="mode"]:checked').value; }

function renderPreview(){
  const area = $('#previewArea');
  const mode = currentMode();
  if(mode==='grafico'){
    area.innerHTML = buildGraphicalTicketHTML();
  } else {
    area.innerHTML = `<pre class="ticket-text">${buildTextTicket()}</pre>`;
  }
}

/* ===== Ticket grafico ===== */
function buildGraphicalTicketHTML(){
  const C = window._calc||calc()||window._calc;
  const d = dataIncasso.value ? new Date(dataIncasso.value+'T00:00:00').toLocaleDateString('it-IT') : new Date().toLocaleDateString('it-IT');
  // Per-slot details
  const slotHtml = C.rowsS.map((r,i)=>{
    const M = eur(toNum(r.querySelector('input[data-k="monete"]').value));
    const I = eur(toNum(r.querySelector('input[data-k="in"]').value));
    const O = eur(toNum(r.querySelector('input[data-k="out"]').value));
    const U = r.querySelector('[data-k="utile"]').textContent;
    return `
      <div class="t-row"><span>S${i+1} Monete</span><b>${M}</b></div>
      <div class="t-row"><span>IN / OUT</span><b>${I} / ${O}</b></div>
      <div class="t-row"><span>Utile</span><b>${U}</b></div>`;
  }).join('');
  const chgHtml = C.rowsC.map((r,i)=>{
    const F = eur(toNum(r.querySelector('input[data-k="fondo"]').value));
    const M = eur(toNum(r.querySelector('input[data-k="monete"]').value));
    const B = eur(toNum(r.querySelector('input[data-k="banconote"]').value));
    return `
      <div class="t-row"><span>C${i+1} Fondo</span><b>${F}</b></div>
      <div class="t-row"><span>Monete / Banconote</span><b>${M} / ${B}</b></div>`;
  }).join('');

  const pill = diffPill.textContent;

  return `
  <div class="ticket">
    <div class="t-head">
      <div class="title">${(nomeLocale.value||'INCASSO VIRTUALE').toUpperCase()}</div>
      <div class="sub">Data: ${d}</div>
    </div>

    <div class="t-sec">
      <h4>Slot</h4>
      ${slotHtml || `<div class="t-row"><span>‚Äî</span><b>‚Ç¨ 0,00</b></div>`}
      <div class="t-row"><span><b>Somma monete</b></span><b>${eur(C.sMon)}</b></div>
    </div>

    <div class="t-sec">
      <h4>Cambiamonete</h4>
      ${chgHtml || `<div class="t-row"><span>‚Äî</span><b>‚Ç¨ 0,00</b></div>`}
      <div class="t-row"><span><b>Fondi cambia</b></span><b>${eur(C.fC)}</b></div>
      <div class="t-row"><span><b>Monete cambia</b></span><b>${eur(C.mC)}</b></div>
      <div class="t-row"><span><b>Banconote cambia</b></span><b>${eur(C.bC)}</b></div>
    </div>

    <div class="t-sec">
      <h4>Extra</h4>
      <div class="t-row"><span>Altre monete + banconote</span><b>${eur(C.altM + C.altB)}</b></div>
      <div class="t-row"><span>Acconti periodo</span><b>${eur(C.acc)}</b></div>
    </div>

    <div class="t-sec">
      <h4>Ripartizione</h4>
      <div class="t-row"><span>Totale IN</span><b>${eur(C.sIn)}</b></div>
      <div class="t-row"><span>Totale OUT</span><b>${eur(C.sOut)}</b></div>
      <div class="t-row"><span>Utile lordo</span><b>${eur(C.sUtile)}</b></div>
      <div class="t-row"><span>PREU</span><b>${eur(C.preu)}</b></div>
      <div class="t-row"><span>AAMS</span><b>${eur(C.aams)}</b></div>
      <div class="t-row"><span>Rete</span><b>${eur(C.rete)}</b></div>
      <div class="t-row"><span><b>Tasse totali</b></span><b><b>${eur(C.tasse)}</b></div>
      <div class="t-row"><span><b>Netto da ripartire</b></span><b><b>${eur(C.netto)}</b></div>
      <div class="t-row"><span>% Esercente</span><b>${C.pEs?.toFixed(1)||toNum(percEsercente.value).toFixed(1)} %</b></div>
      <div class="t-row"><span><b>Verso Esercente</b></span><b><b>${eur(C.qEs)}</b></div>
      <div class="t-row"><span>Verso Gestore</span><b>${eur(C.qGe)}</b></div>
    </div>

    <div class="t-sec">
      <h4>Controllo Virtuale</h4>
      <div class="t-row"><span>Œ£ Fondi</span><b>${eur(C.totFondiAll)}</b></div>
      <div class="t-row"><span>Œ£(IN‚àíOUT)</span><b>${eur(C.sUtile)}</b></div>
      <div class="t-row"><span><b>Incasso Virtuale</b></span><b><b>${eur(C.incassoVirtuale)}</b></div>
      <div class="t-emph">${pill}</div>
      ${note.value?`<div class="t-foot"><b>Note:</b> ${note.value}</div>`:''}
    </div>
  </div>`;
}

/* ===== Scontrino testo 32 colonne ===== */
const W=32;
const rule = (c='-')=> c.repeat(W);
const padR=(s,n)=> (s+ ' '.repeat(Math.max(0,n-s.length))).slice(0,n);
const padL=(s,n)=> (' '.repeat(Math.max(0,n-s.length))+s).slice(-n);
const lr=(l,r)=> padR(l, W - String(r).length) + r;
function buildTextTicket(){
  const C = window._calc||calc()||window._calc;
  const head = (nomeLocale.value||'INCASSO VIRTUALE').toUpperCase();
  const d = dataIncasso.value ? new Date(dataIncasso.value+'T00:00:00').toLocaleDateString('it-IT') : new Date().toLocaleDateString('it-IT');
  const lines=[];
  lines.push(padR(head,W));
  lines.push(padR('DATA: '+d,W));
  lines.push(rule('='));
  lines.push('SLOT');
  lines.push(rule());
  C.rowsS.forEach((r,i)=>{
    const M=toNum(r.querySelector('input[data-k="monete"]').value);
    const I=toNum(r.querySelector('input[data-k="in"]').value);
    const O=toNum(r.querySelector('input[data-k="out"]').value);
    const U=I-O;
    lines.push(lr(`S${i+1} MON`, (M).toFixed(2)));
    lines.push(lr('   IN/OUT', `${I.toFixed(2)}/${O.toFixed(2)}`));
    lines.push(lr('   UTILE', U.toFixed(2)));
  });
  lines.push(rule());
  lines.push(lr('MONETE SLOT', (C.sMon).toFixed(2)));
  lines.push(lr('IN SLOT', (C.sIn).toFixed(2)));
  lines.push(lr('OUT SLOT', (C.sOut).toFixed(2)));
  lines.push(lr('UTILE LORDO', (C.sUtile).toFixed(2)));
  lines.push('');
  lines.push('CAMBIAMONETE');
  lines.push(rule());
  C.rowsC.forEach((r,i)=>{
    const F=toNum(r.querySelector('input[data-k="fondo"]').value);
    const M=toNum(r.querySelector('input[data-k="monete"]').value);
    const B=toNum(r.querySelector('input[data-k="banconote"]').value);
    lines.push(lr(`C${i+1} FONDO`, F.toFixed(2)));
    lines.push(lr('   MON/BAN', `${M.toFixed(2)}/${B.toFixed(2)}`));
  });
  lines.push(rule());
  lines.push(lr('FONDI SLOT', (C.totFondoS).toFixed(2)));
  lines.push(lr('FONDI CAMBIA', (C.fC).toFixed(2)));
  lines.push(lr('Œ£ FONDI', (C.totFondiAll).toFixed(2)));
  lines.push('');
  lines.push('EXTRA');
  lines.push(rule());
  lines.push(lr('ALTRE MONETE', (C.altM).toFixed(2)));
  lines.push(lr('ALTRE BANCON', (C.altB).toFixed(2)));
  lines.push(lr('ACCONTI', (C.acc).toFixed(2)));
  lines.push('');
  lines.push('RIPARTIZIONE');
  lines.push(rule());
  lines.push(lr('Œ£ IN', (C.sIn).toFixed(2)));
  lines.push(lr('Œ£ OUT', (C.sOut).toFixed(2)));
  lines.push(lr('UTILE', (C.sUtile).toFixed(2)));
  lines.push(lr('PREU', (C.preu).toFixed(2)));
  lines.push(lr('AAMS', (C.aams).toFixed(2)));
  lines.push(lr('RETE', (C.rete).toFixed(2)));
  lines.push(lr('TASSE', (C.tasse).toFixed(2)));
  lines.push(lr('NETTO', (C.netto).toFixed(2)));
  lines.push(lr('% ESERC.', (C.pEs??toNum(percEsercente.value)).toFixed(1)));
  lines.push(lr('ESERCENTE', (C.qEs).toFixed(2)));
  lines.push(lr('GESTORE', (C.qGe).toFixed(2)));
  lines.push('');
  lines.push('CONTROLLO VIRT.');
  lines.push(rule());
  lines.push(lr('INCASSO VIRT.', (C.incassoVirtuale).toFixed(2)));
  const label = Math.abs(C.incassoVirtuale)<0.005 ? 'OK ZERO' : (C.incassoVirtuale>0?'CRESCONO':'MANCANO');
  lines.push(lr(label, (C.incassoVirtuale).toFixed(2)));
  if(note.value){ lines.push(''); lines.push('NOTE:'); lines.push(padR(note.value,W)); }
  lines.push(''); lines.push('Operatore: _____________');
  return lines.join('\n');
}

/* ===== Stampa ===== */
function printTicket(){
  const mode = currentMode();
  const g = $('#printGraph'), t = $('#printText');
  g.classList.remove('active'); t.classList.remove('active');
  if(mode==='grafico'){
    g.innerHTML = buildGraphicalTicketHTML();
    g.classList.add('active');
  }else{
    t.innerHTML = `<pre class="ticket-text">${buildTextTicket()}</pre>`;
    t.classList.add('active');
  }
  window.print();
}

/* ===== Statistiche (grafici + numeri) ===== */
let chartInOut, chartRip, chartPayout;
function renderStats(){
  const C = window._calc||calc()||window._calc;
  // Numeri
  const payoutAvg = C.sIn>0 ? (C.sOut/C.sIn*100) : 0;
  $('#statsText').innerHTML =
    `IN: <b>${eur(C.sIn)}</b> ‚Ä¢ OUT: <b>${eur(C.sOut)}</b> ‚Ä¢ Utile: <b>${eur(C.sUtile)}</b> ‚Ä¢ `+
    `Tasse: <b>${eur(C.tasse)}</b> ‚Ä¢ Netto: <b>${eur(C.netto)}</b> ‚Ä¢ `+
    `Esercente: <b>${eur(C.qEs)}</b> ‚Ä¢ Gestore: <b>${eur(C.qGe)}</b> ‚Ä¢ `+
    `Payout medio: <b>${payoutAvg.toFixed(2)}%</b>`;

  // Dataset per slot
  const labelsS = C.rowsS.map((_,i)=>'S'+(i+1));
  const dataIn  = C.rowsS.map(r=>toNum(r.querySelector('input[data-k="in"]').value));
  const dataOut = C.rowsS.map(r=>toNum(r.querySelector('input[data-k="out"]').value));
  const payoutPerSlot = C.rowsS.map((r,i)=>{
    const iN = dataIn[i]; const o = dataOut[i];
    return iN>0 ? (o/iN*100) : 0;
  });

  const hasCharts = typeof Chart!=='undefined';
  $('#statsFallback').style.display = hasCharts ? 'none' : 'block';
  if(!hasCharts) return;

  if(chartInOut) chartInOut.destroy();
  if(chartRip) chartRip.destroy();
  if(chartPayout) chartPayout.destroy();

  chartInOut = new Chart($('#chartInOut').getContext('2d'), {
    type:'bar',
    data:{labels:labelsS,datasets:[
      {label:'IN',data:dataIn},
      {label:'OUT',data:dataOut}
    ]},
    options:{responsive:true,plugins:{legend:{position:'top'},title:{display:true,text:'IN/OUT per Slot'}}}
  });

  chartRip = new Chart($('#chartRip').getContext('2d'), {
    type:'pie',
    data:{labels:['PREU','AAMS','Rete','Esercente','Gestore'],
      datasets:[{data:[C.preu,C.aams,C.rete,C.qEs,C.qGe]}]},
    options:{plugins:{title:{display:true,text:'Ripartizione dell‚Äôutile lordo'}}}
  });

  chartPayout = new Chart($('#chartPayout').getContext('2d'),{
    type:'bar',
    data:{labels:labelsS,datasets:[{label:'Payout %',data:payoutPerSlot}]},
    options:{plugins:{title:{display:true,text:'Payout per Slot'}},
      scales:{y:{ticks:{callback:(v)=>v+'%'}}}}
  });
}

/* ===== Init ===== */
buildTables(); // prebuild
updateSub();
document.addEventListener('input', (e)=>{
  if(e.target && e.target.tagName==='INPUT') calc();
});
</script>
</body>
</html>
